AutoTM - Tide Metrics Automation
---

Python script to automate the collection, analysis, and visualization of metrics for the TIDE cluster. It uses the requests library to poll a prometheus endpoint with a PromQL query, or load data directly from CSV files.

## Installation

The installation instructions assume that you have:
- Python 3.12.6 or later

1. Clone the repository to your local directory with `git clone https://github.com/east-01/AutoTM.git`.
2. Install the requirements with `pip install -r <path_to_install>\requirements.txt`.
3. After everything installs, AutoTM will be ready for use.

## Usage

AutoTM is run from the command line, the base version of it can be run with:
```
python src/main.py <analyses>
```
Where \<analyses\> is a list of analysis options you want to perform, separated by a comma. See the [command line arguments](#command-line-arguments) section to fully use AutoTM.

**Note**: If you want to see the visualizations generated by AutoTM, you must provide an output directory for the .png file to be placed in.

### Analysis options

Analysis options must be spelled correctly and listed without spaces. Here is an example of a valid command collecting the amount of GPU hours and GPU jobs.
```
python src/main.py gpuhours,gpujobs
```
You can use `all` to denote all analysis options, so if you wanted to collect analyses for all of the following options you would do:
```
python src/main.py all
```

Option | Description | Visualization type |
-------|-------------|--------------------|
cpuhours | The amount of CPU hours consumed by each namespace. | Horizontal bar
cpuhourstotal | The total amount of CPU hours consumed by all namespaces. | N/A
cpuhoursavailable | The amount of CPU core hours available during time period. | N/A
gpuhours | The amount of GPU hours consumed by each namespace. | Horizontal bar
gpuhourstotal | The total amount of GPU hours consumed by all namespaces. | N/A
gpuhoursavailable | The total amount of GPU hours available during time period. | N/A
cpujobs | The amount of unique *cpu only* jobs for each namespace. | Horizontal bar
cpujobstotal | The total amount of cpu jobs between all namespaces. | N/A
gpujobs | The amount of unique jobs for each namespace. | Horizontal bar
gpujobstotal | The total amount of gpu jobs between all namespaces. | N/A
jobstotal | The total amount of cpu and gpu jobs between all namespaces. | N/A
cvgpuhours | The total amount of cpu and gpu hours compared across all periods. | Time series
cvgpujobs | The total amount of cpu and gpu jobs compared across all periods. | Time series
utilization | A comparison of resource hours used vs available across all periods. | N/A

### Command line arguments

Command line arguments can be used to greatly fine tune the source of the data. However, there are two groups of command line arguments that must be considered: the arguments for using PromQL vs. the arguments for using local .CSV files.

#### PromQL related arguments

These arguments should not be used when inputting a custom file/directory. If either the start or end times of the period exceed the current time, AutoTM will throw an error.

Argument | Description | Example usage
---------|-------------|--------------
-p or --period | The period to analyze. | -p \<period\>

There are multiple formats for the period argument depending on what you want to see.

Format | Example
-------|---------
Year | -p 2024
MonthYear | -p January25
MonthYear range | -p January25-March25
Unix timestamp range | -p 1738396800-1740815999

#### Input file related arguments

These arguments should not be used when using a PromQL query.

Argument | Description | Example usage
---------|-------------|--------------
-f or --file | The input file/directory to use. The argument parser will automatically read if you have a single file or a directory. | -f "./input/input_file.csv" or -f "./input"

#### Other arguments

These arguments can be used with either a PromQL query or custom file/directory input.

Argument | Description | Example usage
---------|-------------|--------------
-o or --outdir | The directory that the result files will be placed in. | -o "./output"
-c or --config | The .yaml config file that you want to use. | -c "./config.yaml"
-v | Verbose messaging in the console. | -v

### Configuration

Located in config.yaml in the same directory as tidemetrics.py, the config file is a place to store options that won't change very often.

Config section | Description
---------------|------------
base_url | The url endpoint that PromQL queries will go to via a GET request.
step | The period *in seconds* for each PromQL query.
query | The query string that will be used for the PromQL request. **Must contain** the keyword `%TYPE_STRING%` where you want your resource type to go.